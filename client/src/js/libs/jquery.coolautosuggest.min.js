/**
 * jQuery Plugin for creating AJAX auto-suggest textfield
 * @version 2.1
 * @requires jQuery 1.4 or later
 *
 * Copyright (c) 2011 Lucky
 * Licensed under the GPL license:
 *   http://www.gnu.org/licenses/gpl.html
 */
 
(function(a){function b(f,d){this.divId="suggestions_holder";this.hovered=false;this.arrData=null;this.textField=d;this.callBackUrl=f;var c=this.textField.width()+3;var g=1;var l=0;var k="suggest_row";var e="suggest_item";this.idField=null;this.submitOnSelect=false;this.thumbnail=false;this.description=false;this.textField.after('<div class="suggestions" id="'+this.divId+'"></div>');this.textField.attr("autocomplete","off");this.holder=this.textField.next("#"+this.divId);this.holder.hide();this.onSelected=null;var h=this;this.textField.keyup(function(m){if(m.keyCode!=37&&m.keyCode!=38&&m.keyCode!=39&&m.keyCode!=40&&m.keyCode!=13){if(a(this).val().length>=g){a.ajax({url:h.callBackUrl+encodeURI(a(this).val()),success:function(q){try{h.arrData=a.parseJSON(q);var s=h.arrData;var r="";l=0;if(s==null){h.hide()}else{if(s.length>0){for(i=0;i<s.length;i++){cssClass=e;if(i==0){cssClass+=" first"}if(i==(s.length-1)){cssClass+=" last"}var p="";if(h.idField!=null){p=' id_field="'+s[i].id+'"'}var n="";if(h.thumbnail==true){var o="";if(s[i].thumbnail!=undefined){o=' style="background-image:url('+s[i].thumbnail+');"'}n='<div class="thumbnail"'+o+"></div>"}var t="";if(h.description==true){if(s[i].description!=undefined){t='<div class="description">'+s[i].description+"</div>"}}r+='<div id="'+k+(i+1)+'" class="'+cssClass+'"'+p+' seq_id="'+i+'" >'+n+'<div class="suggestion_title">'+s[i].data.replace(new RegExp("("+h.textField.val()+")","gi"),"<b>$1</b>")+"</div>"+t+"</div>"}h.holder.html(r);for(i=1;i<=s.length;i++){var v=h.holder.find("#"+k+i);v.mouseover(function(w){h.hovered=true;h.unSelectAll(this);a(this).addClass("selected")});v.mouseout(function(w){h.hovered=false;a(this).removeClass("selected")});v.click(function(w){h.textField.val(a(this).find(".suggestion_title").text());if(h.idField!=null){h.idField.val(a(this).attr("id_field"))}if(h.onSelected!=null){h.onSelected.call(this,h.arrData[a(this).attr("seq_id")])}if(h.submitOnSelect==true){a("form").has(h.textField).submit()}h.hide()})}h.show(h.holder.find("."+e).height()*s.length)}else{h.hide()}}}catch(u){alert("Sorry, an error has occured!")}},error:function(p,n,o){alert("Sorry, an error has occured!")}})}else{h.hide()}}else{if(h.holder.css("display")!="none"){j(m)}else{if(h.onSelected!=null){h.onSelected.call(this,null)}}}});this.textField.bind("blur",function(m){if(h.idField!=null){if(h.checkSelected(h.textField.val())==false){h.textField.val("");h.idField.val("")}}if(h.hovered==false){h.hide()}else{h.hovered=false}});this.show=function(m){this.holder.css({position:"absolute",left:this.textField.position().left+"px",top:this.textField.position().top+this.textField.height()+5+"px",height:m+"px"});this.holder.css({width:c+"px"});this.holder.find("."+e).css({width:c+"px",overflow:"hidden"});this.holder.show()};this.hide=function(){this.holder.hide()};this.unSelectAll=function(p){var o=a(p).attr("id");var n=this.holder.find("."+e).get().length;for(i=1;i<=n;i++){this.holder.find("#"+k+i).removeClass("selected")}l=parseInt(o.replace(k,""));var m=/^[0-9]+$/;if(!m.test(l)){l=0}};this.setWidth=function(m){c=m};this.setMinChars=function(m){g=m};this.preventEnter=function(){this.textField.keypress(function(m){if(m.keyCode==13){return false}return true})};this.checkSelected=function(n){if(this.arrData!=null){for(var m=0;m<this.arrData.length;m++){if(this.arrData[m].data==n){return true}}}return false};function j(o){if(h.holder.css("display")!="none"){var m=h.holder.find("."+e).get().length;if(o.keyCode==40){l++;if(l<=m){if(l>0){h.holder.find("#"+k+(l-1)).removeClass("selected")}var n=h.holder.find("#"+k+l);n.addClass("selected");h.textField.val(n.find(".suggestion_title").text());if(h.idField!=null){h.idField.val(n.attr("id_field"))}}else{l=m}}else{if(o.keyCode==38){l--;if(l>0){if(l<m){h.holder.find("#"+k+(l+1)).removeClass("selected")}var n=h.holder.find("#"+k+l);n.addClass("selected");h.textField.val(n.find(".suggestion_title").text());if(h.idField!=null){h.idField.val(n.attr("id_field"))}}else{l=1}}else{if(o.keyCode==13){if(h.idField!=null){if(h.checkSelected(h.textField.val())==false){h.textField.val("");h.idField.val("")}}if(h.onSelected!=null){if(l>0){h.onSelected.call(this,h.arrData[l-1])}else{h.onSelected.call(this,null)}}h.hide()}}}}else{if(h.onSelected!=null){h.onSelected.call(this,null)}}return true}}a.fn.coolautosuggest=function(c){var d={width:null,minChars:null,idField:null,submitOnSelect:false,showThumbnail:false,showDescription:false,onSelected:null};a.extend(d,c);return this.each(function(){var e=new b(d.url,a(this));if(d.width!=null){e.setWidth(d.width)}if(d.minChars!=null){e.setMinChars(d.minChars)}if(d.idField!=null){e.idField=d.idField;e.preventEnter()}if(d.submitOnSelect==true){e.submitOnSelect=true}else{e.preventEnter()}if(d.showThumbnail==true){e.thumbnail=d.showThumbnail}if(d.showDescription==true){e.description=d.showDescription}if(a.isFunction(d.onSelected)==true){e.onSelected=d.onSelected}})}})(jQuery);